<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Rendering NSTextAttachment inline in a UITextView &#8211; Pete Hare</title>
<meta name="description" content="Getting text attachments to behave well with font baselines">
<meta name="keywords" content="">



<!-- Twitter Cards -->
<meta name="twitter:title" content="Rendering NSTextAttachment inline in a UITextView">
<meta name="twitter:description" content="Getting text attachments to behave well with font baselines">
<meta name="twitter:site" content="@petehare">
<meta name="twitter:creator" content="@petehare">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Rendering NSTextAttachment inline in a UITextView">
<meta property="og:description" content="Getting text attachments to behave well with font baselines">
<meta property="og:url" content="/inline-nstextattachment-rendering-in-uitextview/">
<meta property="og:site_name" content="Pete Hare">





<link rel="canonical" href="/inline-nstextattachment-rendering-in-uitextview/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Pete Hare Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<script src="//use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="/assets/js/vendor/html5shiv.min.js"></script>
  <script src="/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		        
		    
		    <li><a href="/" >Blog</a></li>
		  
		    
		        
		    
		    <li><a href="/about/" >About</a></li>
		  
		    
		        
		    
		    <li><a href="/projects/" >Projects</a></li>
		  
        
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->



<header class="masthead">
	<div class="wrap">
        
        <h1 class="site-title animated fadeIn"><a href="">Pete Hare</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">A software developer's ramblings...</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>

<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"></span>
        
          <h1 class="entry-title">Rendering NSTextAttachment inline in a UITextView</h1>
        
      </header>
      <footer class="entry-meta">
        
        
        
          <img src="/images/avatar.png" class="bio-photo" alt="Pete Hare bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Pete Hare</span></span>
        <span class="entry-date date published"><time datetime="2014-12-19T17:32:09-08:00"><i class="fa fa-calendar-o"></i> December 19, 2014</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=&amp;text=Rendering%20NSTextAttachment%20inline%20in%20a%20UITextView&amp;url=/inline-nstextattachment-rendering-in-uitextview/&amp;via=petehare" title="Share on Twitter" itemprop="Twitter"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=/inline-nstextattachment-rendering-in-uitextview/" title="Share on Facebook" itemprop="Facebook"><i class="fa fa-facebook-square"></i> Like</a>
</span>
<span class="social-share-googleplus">
  <a href="https://plus.google.com/share?url=/inline-nstextattachment-rendering-in-uitextview/" title="Share on Google Plus" itemprop="GooglePlus"><i class="fa fa-google-plus-square"></i> +1</a>
</span>
<!-- /.social-share -->
        
      </footer>
      <div class="entry-content">
        <h1 id="background">Background</h1>

<p>Apple’s Mail app for iOS seems to treat a single email address as a single character once entered. When you try to edit the text, the whole email is selected.</p>

<p><img src="/images/Screen Shot 2014-12-19 at 8.55.14 PM.png" alt="Email selecting" /></p>

<p>In an attempt to mimic the email entry behaviour of the Mail app, I came upon an issue when rendering instances of <code>NSTextAttachment</code> inside a <code>UITextView</code>.</p>

<h1 id="the-problem">The Problem</h1>

<p>To accomplish this, I attempted to take snapshots of the entered text, and render it as a text attachment inline with any additional text (I might write another post about the data source behaviour another time).</p>

<p>The technique worked very well, except I found my text baseline was being thrown around a bit.</p>

<p><img src="/images/Screen Shot 2014-12-19 at 9.02.50 PM.png" alt="NSTextAttachment Baseline" /></p>

<p>This had me stumped for a while. The <code>UIImage</code> that I had generated for the <code>NSTextAttachment</code> was simply a <code>UILabel</code> rendered offscreen, and then sized to fit. Given that all my font sizes and string attributes matched up, there should not be any reason for the baselines to not line up <em>perfectly</em>.</p>

<p>I set a background colour on the label to investigate:</p>

<p><img src="/images/Screen Shot 2014-12-20 at 1.02.48 AM.png" alt="Background colour showing baseline" /></p>

<p><img src="/images/Screen Shot 2014-12-20 at 1.03.06 AM.png" alt="Close up of descenders" /></p>

<p>Aha! It looks like by default, the <code>UITextView</code> renders instances of <code>NSTextAttachment</code> on the <em>baseline</em>, extending upwards. This means the larger the image, the further down my baseline of the following text will be pushed.</p>

<p>You can see the snapshotted <code>UILabel</code> has space at the bottom for it’s descenders, so we don’t want it rendering on the baseline.</p>

<h1 id="the-solution">The Solution</h1>

<p>After spending far too much time delving into various TextKit classes, I came up with a fairly straightforward solution.</p>

<p>I started checking out the <code>NSLayoutManager</code> class, as that seemed to control how glyphs and characters are positioned in a text container. However it turns out that the <code>NSTextAttachment</code> class already has a method returning it’s bounds:</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="p">-</span><span class="nf">attachmentBoundsForTextContainer:proposedLineFragment:glyphPosition:characterIndex:</span></code></pre></div>

<p>So, I made a simple subclass of <code>NSTextAttachment</code> which exposes a property for adjusting the y-offset of the attachment bounds.</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">InlineTextAttachment</span> : <span class="bp">NSTextAttachment</span>

<span class="k">@property</span> <span class="n">CGFloat</span> <span class="n">fontDescender</span><span class="p">;</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">InlineTextAttachment</span>

<span class="p">-</span> <span class="p">(</span><span class="bp">CGRect</span><span class="p">)</span><span class="nf">attachmentBoundsForTextContainer:</span><span class="p">(</span><span class="bp">NSTextContainer</span> <span class="o">*</span><span class="p">)</span><span class="nv">textContainer</span> <span class="nf">proposedLineFragment:</span><span class="p">(</span><span class="bp">CGRect</span><span class="p">)</span><span class="nv">lineFrag</span> <span class="nf">glyphPosition:</span><span class="p">(</span><span class="bp">CGPoint</span><span class="p">)</span><span class="nv">position</span> <span class="nf">characterIndex:</span><span class="p">(</span><span class="bp">NSUInteger</span><span class="p">)</span><span class="nv">charIndex</span> <span class="p">{</span>
	<span class="bp">CGRect</span> <span class="n">superRect</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="nl">attachmentBoundsForTextContainer</span><span class="p">:</span><span class="n">textContainer</span> <span class="nl">proposedLineFragment</span><span class="p">:</span><span class="n">lineFrag</span> <span class="nl">glyphPosition</span><span class="p">:</span><span class="n">position</span> <span class="nl">characterIndex</span><span class="p">:</span><span class="n">charIndex</span><span class="p">];</span>
	<span class="n">superRect</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">fontDescender</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">superRect</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span></code></pre></div>

<p>Using this subclass now, I can grab the descender value from the font I’m using in my attributed string.</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="bp">UIImage</span> <span class="o">*</span><span class="n">labelImage</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span> <span class="nl">snapshotImageAfterScreenUpdates</span><span class="p">:</span><span class="nb">NO</span><span class="p">];</span>
<span class="n">InlineTextAttachment</span> <span class="o">*</span><span class="n">attachment</span> <span class="o">=</span> <span class="p">[[</span><span class="n">InlineTextAttachment</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithData</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">ofType</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="bp">UIFont</span> <span class="o">*</span><span class="n">font</span> <span class="o">=</span> <span class="p">[</span><span class="n">aString</span> <span class="nl">attribute</span><span class="p">:</span><span class="n">NSFontAttributeName</span> <span class="nl">atIndex</span><span class="p">:</span><span class="mi">0</span> <span class="nl">effectiveRange</span><span class="p">:</span><span class="nb">NULL</span><span class="p">];</span>

<span class="n">attachment</span><span class="p">.</span><span class="n">fontDescender</span> <span class="o">=</span> <span class="n">font</span><span class="p">.</span><span class="n">descender</span><span class="p">;</span>
<span class="n">attachment</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">labelImage</span><span class="p">;</span></code></pre></div>

<p>And bingo! The descender height was exactly the offset I needed to get all my <code>NSTextAttachment</code> instances to line up nicely with my existing text.</p>

<p><img src="/images/Screen Shot 2014-12-20 at 12.48.50 AM.png" alt="Final result" /></p>

        <div id="disqus_thread"></div><!-- /#disqus_thread -->
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2014 Pete Hare. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://mademistakes.com/so-simple/" rel="nofollow">So Simple Theme</a>.</span>
<div class="social-icons">
	<a href="http://twitter.com/petehare" title="Pete Hare on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	
	
	
	<a href="http://stackoverflow.com/users/1476170/petehare" title="Pete Hare on StackExchange" target="_blank"><i class="fa fa-stack-exchange fa-2x"></i></a>
	
	
	<a href="http://github.com/petehare" title="Pete Hare on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  <a href="/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-57889968-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



  
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'petehare'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


	        

</body>
</html>
